<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/notas-de-aprendizaje/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/notas-de-aprendizaje/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/notas-de-aprendizaje/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/notas-de-aprendizaje/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Mastering Chaos: A Netflix Guide to Microservices | Notes</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Mastering Chaos: A Netflix Guide to Microservices" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Keyvan Akbary learning notes" /> <meta property="og:description" content="Keyvan Akbary learning notes" /> <meta property="og:site_name" content="Notes" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Mastering Chaos: A Netflix Guide to Microservices" /> <script type="application/ld+json"> {"@type":"WebPage","description":"Keyvan Akbary learning notes","url":"/notas-de-aprendizaje/talks/mastering-chaos-a-netflix-guide-to-microservices/","headline":"Mastering Chaos: A Netflix Guide to Microservices","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/notas-de-aprendizaje/" class="site-title lh-tight"> Notes </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/notas-de-aprendizaje/articles/" class="nav-list-link">Articles</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/notas-de-aprendizaje/books/" class="nav-list-link">Books</a><ul class="nav-list "></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/notas-de-aprendizaje/talks/" class="nav-list-link">Talks</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/notas-de-aprendizaje/papers/" class="nav-list-link">Papers</a><ul class="nav-list "></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Notes" aria-label="Search Notes" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/sanrm/notas-de-aprendizaje" class="site-button" > Notas de aprendizaje en GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/notas-de-aprendizaje/talks/">Talks</a></li> <li class="breadcrumb-nav-list-item"><span>Mastering Chaos: A Netflix Guide to Microservices</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="mastering-chaos-a-netflix-guide-to-microservices"> <a href="#mastering-chaos-a-netflix-guide-to-microservices" class="anchor-heading" aria-labelledby="mastering-chaos-a-netflix-guide-to-microservices"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://www.youtube.com/watch?v=CZ3wIuvmHeM">Mastering Chaos: A Netflix Guide to Microservices</a> </h1> <h2 id="microservices-basics"> <a href="#microservices-basics" class="anchor-heading" aria-labelledby="microservices-basics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Microservices basics </h2> <p>What microservices are not:</p> <ul> <li><strong>Monolithic code base.</strong> Everyone was contributing to a single code base that was released once a week, when change introduced a problem it was difficult and slow to debug. Because so many changes were released on a single deploy.</li> <li><strong>Monolithic database.</strong> When this went down, everything went down. Scaling it vertically was very expensive.</li> <li><strong>Tightly coupled architecture.</strong> One of the most painful points was the lack of agility, everything was deeply interconnected.</li> </ul> <p>What is a microservice: An evolutionary response</p> <ul> <li>Separation of concerns. Modularity, encapsulation</li> <li>Scalability. Horizontally scaling, workload partitioning</li> <li>Virtualisation and elasticity. Automated operations, on demand provisioning</li> </ul> <p>Microservices as organs:</p> <ul> <li>Each organ has a purpose</li> <li>Organs form systems</li> <li>Systems form an organism</li> </ul> <p>Microservices are an abstraction:</p> <ul> <li>You have a <strong>service</strong> that provides some functionality</li> <li>The service may need to access some persistence mechanism like a <strong>database</strong></li> <li>You may provide <strong>service client</strong> for accessing data operations</li> <li>You may provide an <strong>cache for your client</strong> (peg: <a href="https://github.com/Netflix/EVCache">EVCache</a>)</li> <li>You may need to provide some orchestration between the client and the cached client, so you may need to really provide a <strong>client library</strong> that will go to the cache first, and if it fails will go for the client that will hit the microservice and persistence layer and then backfill the cache for the next call</li> <li>All this will have to be embedded within the <strong>client application</strong> that wants to use the</li> </ul> <p>From the consuming application the client library, that includes the service client cache, the service client, the service and the database is the microservice. Is not a simple state thing.</p> <h2 id="challenges-and-solutions"> <a href="#challenges-and-solutions" class="anchor-heading" aria-labelledby="challenges-and-solutions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Challenges and solutions </h2> <h3 id="dependency"> <a href="#dependency" class="anchor-heading" aria-labelledby="dependency"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dependency </h3> <h4 id="infra-service-request"> <a href="#infra-service-request" class="anchor-heading" aria-labelledby="infra-service-request"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Infra-service request </h4> <p>Everything is great until something breaks.</p> <ul> <li>Network latency, congestion, failure.</li> <li>Logical or scaling failure.</li> </ul> <p>Cascading failure, one service fails without defences it can cascade and take down your entire network.</p> <p>Solution: <a href="https://github.com/Netflix/Hystrix">Hystrix</a></p> <ul> <li>Structured way of handling timeouts and retries</li> <li>Fallbacks, if I cannot call a service, can I return some static response instead (degraded service) to allow the customer to continue using the product</li> <li>Isolated threadpools and the concept of circuits. If you keep hammering the service and it keeps failing, maybe you should stop calling it and fail fast returning the fallback</li> </ul> <p>How do you know if it works at scale? Netflix created <a href="https://medium.com/netflix-techblog/fit-failure-injection-testing-35d8e2a9bb2">FIT</a> (Fault Injection Testing) to test this. It inject failure information metadata to <a href="https://github.com/Netflix/zuul">Zuul</a>, and this is carried through the network.</p> <ul> <li>Synthetic transactions</li> <li>Override by device or account</li> <li>% of live traffic up to 100%</li> <li>Enforced throughout the call path</li> </ul> <p>How do we constraint testing scope? (So you are not testing millions of permutations, or downstream dependencies of the services you test). To address this Netflix defined the critical microservices to have basic functionality to work, which is not all of them, and test only those (by blacklisting all of the other services that are not critical). This has worked great to make sure that the service actually functions when all those dependencies go away. This is a much simpler approach than doing point-to-point interactions.</p> <p>Client libraries</p> <ul> <li>Many clients</li> <li>Common business logic</li> <li>Common access patterns</li> </ul> <p>Trade-offs for client libraries</p> <ul> <li>Heap consumption</li> <li>Logical defects</li> <li>Transitive dependencies</li> </ul> <p>We can limit the client libraries, try to simplify them as much as possible.</p> <p>Persistence</p> <ul> <li>CAP theorem</li> </ul> <p>In the presence of a network partition, you must choose between between consistency and availability.</p> <p>Netflix chose availability via Cassandra, systems are eventually consistent.</p> <p>Infrastructure Do not put all your eggs into one basket. <a href="https://www.infoq.com/presentations/netflix-failure-multiple-regions/">You can go multi-region</a>.</p> <h3 id="scale"> <a href="#scale" class="anchor-heading" aria-labelledby="scale"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scale </h3> <h4 id="stateless-services"> <a href="#stateless-services" class="anchor-heading" aria-labelledby="stateless-services"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Stateless services </h4> <ul> <li>Not a cache or a database</li> <li>Frequently accessed metadata</li> <li>No instance affinity</li> <li>Loss a node is non-event, you can replace a node at no cost</li> </ul> <p>Auto scaling groups is fundamental for microservices, advantages</p> <ul> <li>Compute efficiency, on-demand capacity</li> <li>Node failure, nodes gets replaced easily</li> <li>Traffic spikes, DDoS attack, etc.</li> <li>Performance bugs, auto-scaling allows you to absorb damage while figuring out what happened</li> </ul> <p>Surviving instance failure, thanks to Chaos Monkey (losing individual nodes).</p> <h4 id="stateful-services"> <a href="#stateful-services" class="anchor-heading" aria-labelledby="stateful-services"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Stateful services </h4> <ul> <li>Databases and caches</li> <li>Custom apps which hold large amounts of data</li> <li>Loss of a node is a notable event, it could take hours to recover</li> </ul> <p>Redundancy is fundamental, EVCache similar to memcache but it writes to several zones for redundancy</p> <h4 id="hybrid-services"> <a href="#hybrid-services" class="anchor-heading" aria-labelledby="hybrid-services"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hybrid services </h4> <p>It’s easy to take EVCache for granted</p> <ul> <li>30 million requests/sec</li> <li>2 trillion requests per day globally</li> <li>Hundreds of billions of objects</li> <li>Tens of thousands of memcached instances</li> <li>It consistency scales in a linear way, no matter the load. Milliseconds of latency per requests</li> </ul> <p>Problem is you may rely too much on EVCache. Solutions</p> <ul> <li>Workload partitioning, split cache by workload (real-time vs batch processes)</li> <li>Request-level caching, so you are not repeat hitting the service over and over. Make the first hit expensive and the rest of them free through the lifecycle of the application</li> <li>Secure token fallback, embed a secure token through the requests. If the subscriber service is unavailable, fallback to a datastore with that encrypted token so you have enough information to identify the customer and provide basic operation</li> <li>Chaos under load, use tools to test your architecture</li> </ul> <h3 id="variance-within-your-architecture"> <a href="#variance-within-your-architecture" class="anchor-heading" aria-labelledby="variance-within-your-architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Variance within your architecture </h3> <p>The more variety you have in your system, the more complex and difficult to manage it becomes.</p> <h4 id="operational-drift-which-happens-over-time"> <a href="#operational-drift-which-happens-over-time" class="anchor-heading" aria-labelledby="operational-drift-which-happens-over-time"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Operational drift, which happens over time </h4> <p>Unintentional, it happens eventually.</p> <p>Over time</p> <ul> <li>Alert thresholds</li> <li>Timeouts, retries, fallbacks</li> <li>Throughput (RPS)</li> </ul> <p>Across microservices</p> <ul> <li>Reliability best practices</li> </ul> <p>The first time you talk with teams about this, they will be very enthusiastic; however, as this is tedious and repetitive, and is not related to product work, people will tend to avoid it.</p> <p>They solved the cycle with continuous learning and automation. An incident gets a resolution, then a review happens, a remediation plan, some analysis, then extract some learning into best practice, then you automate wherever possible, then you drive adoption.</p> <h5 id="production-ready-checklist"> <a href="#production-ready-checklist" class="anchor-heading" aria-labelledby="production-ready-checklist"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Production ready checklist </h5> <ul> <li>Alerts</li> <li>Apache and Tomcat</li> <li>Automated canary analysis</li> <li>Autoscaling</li> <li>Chaos</li> <li>Consistent naming</li> <li>ELB config</li> <li>Healthcheck</li> <li>Immutable machine images</li> <li>Squeeze testing</li> <li>Staged, red/black deployments</li> <li>Timeouts, retries, fallbacks</li> </ul> <h4 id="polyglot-new-languages-and-containers"> <a href="#polyglot-new-languages-and-containers" class="anchor-heading" aria-labelledby="polyglot-new-languages-and-containers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Polyglot (new languages) and containers </h4> <p>Intentional variance.</p> <p>The paved road, focused on Java and EC2</p> <ul> <li>Stash</li> <li>Nebula/Gradle</li> <li>BaseAMI/Ubuntu</li> <li>Jenkins</li> <li>Spinnaker</li> <li>Runtime platform</li> </ul> <p>Some engineers went off road, building their own roads, doing stuff in Python, Ruby, NodeJS, each one of them provided value in some sense. When Docker was introduced, things went a bit wild.</p> <h4 id="cost-of-variance"> <a href="#cost-of-variance" class="anchor-heading" aria-labelledby="cost-of-variance"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cost of variance </h4> <ul> <li>Productivity tooling</li> <li>Insight and triage capabilities</li> <li>Base image fragmentation</li> <li>Node management</li> <li>Library/platform duplication</li> <li>Learning curve, production expertise</li> </ul> <p>Instead of a single paved road, now we have multiple paved roads that makes life difficult for the teams that support engineering infrastructure.</p> <p>The strategic stance to cost was to</p> <ul> <li>Raise awareness of costs</li> <li>Constraint centralised support, focus specially into JVM, and of course for Docker</li> <li>Prioritise by impact</li> <li>Seek reusable solutions</li> </ul> <p>How do we achieve velocity with worrying about breaking things all the time?</p> <p>Global cloud management and delivery, Spinnaker an automated delivery system.</p> <ul> <li>Conformity checks</li> <li>Red/black pipelines</li> <li>Automated canaries</li> <li>Staged deployments (one region at a time)</li> <li>Squeeze tests</li> </ul> <h2 id="organisation-and-architecture"> <a href="#organisation-and-architecture" class="anchor-heading" aria-labelledby="organisation-and-architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Organisation and architecture </h2> <p>Electronic Delivery, NRDP 1.x. Wasn’t called Streaming yet.</p> <ul> <li>Simple UI, “Queue Reader”</li> <li>Collaborative design</li> <li>XML payloads</li> <li>Custom responses</li> <li>Versioned firmware releases</li> <li>Long cycles</li> </ul> <p>In parallel the Netflix API, let a 1000 flowers bloom. It wasn’t very successful but after that, it started to be used privately</p> <ul> <li>Content Metadata</li> <li>General REST API</li> <li>JSON schema</li> <li>HTTP response codes</li> <li>OAuth security model (it was important for 3rd party apps)</li> </ul> <p>Hybrid architecture, now we have these two edge services functioning in very different ways. Distinct in</p> <ul> <li>Services</li> <li>Protocols</li> <li>Schemas</li> <li>Security</li> </ul> <p>There was a lot of friction between teams, as client developer you would have to change context all the time.</p> <p>Josh: What is the right long term architecture? Peter: Do you care about the organisational implications?</p> <h3 id="conways-law"> <a href="#conways-law" class="anchor-heading" aria-labelledby="conways-law"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conway’s law </h3> <p>Any piece of software reflects the organisational structure that produce it.</p> <p>If you have four teams working on a compiler you will end up with a four pass compiler.</p> <p><strong>This is not solutions first, this is organisation first.</strong></p> <h3 id="outcomes-and-lessons"> <a href="#outcomes-and-lessons" class="anchor-heading" aria-labelledby="outcomes-and-lessons"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Outcomes and lessons </h3> <p>By unifying these things around the client.</p> <p>Outcomes</p> <ul> <li>Productivity and new capabilities</li> <li>Refactored organisation</li> </ul> <p>Lessons</p> <ul> <li>Solutions first, team second</li> <li>Reconfigure teams to best support your architecture</li> </ul><hr /> <p>Microservice architecture as complex and organic.</p> <p>Health depends on discipline and injecting chaos.</p> <p>Dependency</p> <ul> <li>Circuit breakers, fallbacks, chaos</li> <li>Simple clients</li> <li>Eventual consistency</li> </ul> <p>Scale</p> <ul> <li>Auto-scaling</li> <li>Redundancy, avoid SPoF</li> <li>Partioned workloads</li> <li>Failure-driven design</li> <li>Chaos under load</li> </ul> <p>Variance</p> <ul> <li>Engineered operations</li> <li>Understood cost of variance</li> <li>Prioritised support by impact</li> </ul> <p>Change</p> <ul> <li>Automated delivery</li> <li>Integrated practices</li> </ul> <p>Organisation and architecture</p> <ul> <li>Solutions first, team second</li> </ul> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
